{% extends "base.html" %}
{% load i18n %}
{% load humanize %}
{% block title %} Detalle de {{ contrato.contrato_shortName }} {% endblock %}
{% block javascript %}
	<script type="text/javascript">
	$(document).ready(function(){
	    if($(".icon_right").length){
	        function lanzar_catalogo_conceptos(){
	            var data_id = $("#dato")[0].getAttribute("data-id")
	            $(".icon_right-up")[0].style.display = "initial";
	            $(".icon_right")[0].style.display = "none";
	            $.ajax({
	                url: "{% url 'construbot.proyectos:catalogo_conceptos_listado' contrato.id %}",
	                success: function(result){
	                    result = result.conceptos;
	                    len = result.length;
	                    if(len>0){
	                        $(".table_results")[0].style.display = "block";
	                        $(".table_results")[0].style.display = "inline-table";
	                        for(i=1; i<=len; i++){
	                            var row = $(".table_results")[0].insertRow(i);
	                            var row_content = "<td>"+result[i-1]["code"]+"</td><td style='text-align:left;'>"+result[i-1]["concept_text"]+"</td><td>"+result[i-1]["unit"]+"</td><td>"+result[i-1]["cuantity"]+"</td><td>"+"$ "+intcomma(result[i-1]["unit_price"])+"</td>";
	                            row.innerHTML = row_content;
	                        }
	                    } else {
	                        $(".cont_message_no_result")[0].style.display = "block";
	                    }
	                }
	            });
	        }
	        $(".icon_right").on("click", function(){
	            lanzar_catalogo_conceptos();
	        });

	        $(".icon_right-up").on("click", function(){
	            $(".icon_right-up")[0].style.display = "none";
	            $(".icon_right")[0].style.display = "initial";
	            if(len>0){
	                $(".table_results")[0].style.display = "none";
	                $(".table_results")[0].style.display = "none";
	                for(i=0; i<len; i++){
	                    $(".table_results")[0].deleteRow(1);
	                }
	            } else {
	                $(".cont_message_no_result")[0].style.display = "none";
	            }
	        });
	        lanzar_catalogo_conceptos();
	    }
	});
	</script>
{% endblock javascript %}
{% block content %}
{% language 'es' %}
<h2 class="title" > Reporte de contrato </h2>
<div id="dato" data-id="{{ contrato.id }}"></div>
<div class="cont_table_sample">
	<table class="table_sample table_detalle">
		<tr>
			<th colspan="2">{{ contrato.folio }}. {{ contrato.contrato_shortName }}</th>
		</tr>
		<tr>
			<td>Código de contrato</td>
			<td>{{ contrato.code }}</td>
		</tr>
		<tr>
			<td>Nombre corto</td>
			<td>{{ contrato.contrato_shortName }}</td>
		</tr>
		<tr>
			<td>Cliente</td>
			<td>{{ contrato.cliente.cliente_name }}</td>
		</tr>
		<tr>
			<td>Sitio</td>
			<td>{{ contrato.sitio.sitio_name }}</td>
		</tr>
		{% if is_administrador %}
		<tr>
			<td>Monto sin IVA</td>
			<td>$ {% language 'en' %}{{ contrato.monto|intcomma }}{% endlanguage %}</td>
		</tr>
		{% endif %}
		<tr>
			<td>Fecha de Firma</td>
			<td>{{ contrato.fecha|date:"d/F/Y" }}</td>
		</tr>
		<tr>
			<td>¿Terminado?</td>
			<td><strong>{% if status %}Sí{% else %}No{% endif %}</strong></td>
		</tr>
	</table>
</div>
<br>
{% if is_administrador %}
<div class="cont_listado">
	<strong>Catálogo de conceptos </strong>
	<span class="oi oi-chevron-left icon_right"></span><span class="oi oi-chevron-bottom icon_right-up"></span>
	<div class="cont_message_no_result">¡No existe catálogo de concepto!, crear <a href="{% url 'construbot.proyectos:catalogo_conceptos' contrato.id %}">aquí</a>.</div>
</div>
<table class="table_results table_sample">
	<tr>
		<th> Código </th>
		<th style="width:500px;"> Concepto </th>
		<th> Unidad </th>
		<th> Cantidad </th>
		<th> Precio unitario </th>
	</tr>
	<tr>
		<td colspan="5">
			<a href="{% url 'construbot.proyectos:catalogo_conceptos' contrato.id %}">Editar Catálogo</a>
		</td>
	</tr>
</table>
{% endif %}
{% if contrato.estimate_set.exists %}
	<p><strong> Listado de estimaciones </strong></p>
	<table class="table_sample table_normal">
		<tbody>
			<tr>
				<th> No. </th>
				<th> Nombre </th>
				{% if is_administrador %} <th> Monto </th>{% endif %}
				<th> F. de Pago </th>
				<th> Editar </th>
			</tr>
		{% for estimacion in contrato.estimate_set.all %}
			<tr>
				<td>{{ estimacion.consecutive }}</td>
				<td><a href="{% url 'proyectos:estimate_detail' estimacion.id %}">Estimación {{ estimacion.consecutive }}</a></td>
				{% if is_administrador %}<td>{% language 'en' %}$ {{ estimacion.total_estimate.total|intcomma }}{% endlanguage %}</td>{% endif %}
				<td>{{ estimacion.payment_date|date:"d/F/Y" }}</td>
				<td>
					<a href="{% url 'proyectos:editar_estimacion' estimacion.pk %}">Editar</a> /
					<a href="">Eliminar</a>
				</td>
			</tr>
		{% endfor %}
			<tr>
				<td colspan="5">
					<a href="{% url 'proyectos:nueva_estimacion' contrato.id %}">Crear estimación</a>
				</td>
			</tr>
		</tbody>
	</table>
{% else %}
	<h3 class="title"> No existen estimaciones para este contrato aún. <a href="{% url 'proyectos:nueva_estimacion' contrato.id %}">Crea una aquí</a>.</h3>
{% endif %}
{% endlanguage %}
{% endblock %}
