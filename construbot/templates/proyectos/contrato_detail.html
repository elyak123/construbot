{% extends "base.html" %}
{% load i18n %}
{% load humanize %}
{% block title %} Detalle de {{ contrato.contrato_shortName }} {% endblock %}
{% block javascript %}
	<script type="text/javascript">
	let url_for_list = '{% url "proyectos:proyect_dashboard" %}'
	$(document).ready(function(){
	    if($(".icon_right").length){
		    var intcomma = function(value) {
		        // inspired by django.contrib.humanize.intcomma, thanks to @banterabilitybanterability
		        var origValue = String(value);
		        var newValue = origValue.replace(/^(-?\d+)(\d{3})/, '$1,$2');
		        if (origValue == newValue){
		            return newValue;
		        } else {
		            return intcomma(newValue);
		        }
		    };
	        function lanzar_catalogo_conceptos(){
	            var data_id = $("#dato")[0].getAttribute("data-id")
	            $(".icon_right-up")[0].style.display = "initial";
	            $(".icon_right")[0].style.display = "none";
	            $.ajax({
	                url: "{% url 'construbot.proyectos:catalogo_conceptos_listado' contrato.id %}",
	                success: function(result){
	                    result = result.conceptos;
	                    len = result.length;
	                    if(len>0){
	                        $(".table_results")[0].style.display = "block";
	                        $(".table_results")[0].style.display = "inline-table";
	                        for(i=1; i<=len; i++){
	                            var row = $(".table_results")[0].insertRow(i);
	                            var row_content = "<td>"+result[i-1]["code"]+"</td><td style='text-align:left;'>"+result[i-1]["concept_text"]+"</td><td>"+result[i-1]["unit"]+"</td><td>"+result[i-1]["cuantity"]+"</td><td>"+"$ "+intcomma(result[i-1]["unit_price"])+"</td>";
	                            row.innerHTML = row_content;
	                        }
	                    } else {
	                        $(".cont_message_no_result")[0].style.display = "block";
	                    }
	                }
	            });
	        }
	        $(".icon_right").on("click", function(){
	            lanzar_catalogo_conceptos();
	        });

	        $(".icon_right-up").on("click", function(){
	            $(".icon_right-up")[0].style.display = "none";
	            $(".icon_right")[0].style.display = "initial";
	            if(len>0){
	                $(".table_results")[0].style.display = "none";
	                $(".table_results")[0].style.display = "none";
	                for(i=0; i<len; i++){
	                    $(".table_results")[0].deleteRow(1);
	                }
	            } else {
	                $(".cont_message_no_result")[0].style.display = "none";
	            }
	        });
	        lanzar_catalogo_conceptos();
	        let t1;
	        $( "#toggle-button-2" ).click(function() {
	        	$("#toggle-button-2").css('display', 'none');
	        	$("#toggle-button-1").css('display', 'block');
		        $( "#toggle-hide" ).css("display", "none");
			});
			$( "#toggle-button-1" ).click(function() {
	        	$("#toggle-button-2").css('display', 'block');
	        	$("#toggle-button-1").css('display', 'none');
	        	$( "#toggle-hide" ).css("display", "block");
			});
	    }
	});
	</script>
{% endblock javascript %}
{% block content %}
{% language 'es' %}
<h2 class="title" > Reporte de contrato </h2>
<div id="dato" data-id="{{ contrato.id }}"></div>
<div class="cont_table_sample">
	<table class="table_sample table_detalle">
		<tr>
			<th colspan="2">{{ contrato.folio }}. {{ contrato.contrato_shortName }}</th>
		</tr>
		<tr>
			<td>Código de contrato</td>
			<td>{{ contrato.code }}</td>
		</tr>
		<tr>
			<td>Nombre corto</td>
			<td>{{ contrato.contrato_shortName }}</td>
		</tr>
		<tr>
			<td>Cliente</td>
			<td><a href="{% url 'construbot.proyectos:cliente_detail' contrato.cliente.id %}">{{ contrato.cliente.cliente_name }}</a></td>
		</tr>
		<tr>
			<td>Sitio</td>
			<td><a href="{% url 'construbot.proyectos:sitio_detail' contrato.sitio.id %}">{{ contrato.sitio.sitio_name }}</a></td>
		</tr>
		{% if almenos_coordinador %}
		<tr>
			<td>Monto sin IVA</td>
			<td>$ {% language 'en' %}{{ contrato.monto|intcomma }}{% endlanguage %}</td>
		</tr>
		{% endif %}
		<tr>
			<td>Fecha de Firma</td>
			<td>{{ contrato.fecha|date:"d/F/Y" }}</td>
		</tr>
		<tr>
			<td>¿Terminado?</td>
			<td><strong>{% if status %}Sí{% else %}No{% endif %}</strong></td>
		</tr>
		{% if almenos_coordinador %}
		<tr>
			<td class="text-center" colspan="2"><a href="{% url 'proyectos:editar_contrato' contrato.pk %}">Editar Contrato</a></td>
		</tr>
		{% endif %}
	</table>
</div>
<br>
{% if almenos_coordinador %}
<div class="cont_listado">
	<strong>Catálogo de conceptos </strong>
	<span class="oi oi-plus icon_right"></span><span class="oi oi-minus icon_right-up"></span>
	<div class="cont_message cont_message_no_result" style="background:white;">¡No existe catálogo de concepto!, crear <a href="{% url 'construbot.proyectos:catalogo_conceptos' contrato.id %}">aquí</a>.</div>
</div>
<table class="table_results table_sample">
	<tr>
		<th> Código </th>
		<th style="width:500px;"> Concepto </th>
		<th> Unidad </th>
		<th> Cantidad </th>
		<th> Precio unitario </th>
	</tr>
	<tr>
		<td colspan="5">
			<a href="{% url 'construbot.proyectos:catalogo_conceptos' contrato.id %}">Editar Catálogo</a>
		</td>
	</tr>
</table>
{% endif %}
<br>
<br>
{% if contrato.estimate_set.exists %}
	<div class="cont_listado alert alert-danger" id="cont_est_danger">
	</div>
	<div class="cont_listado">
		<strong> Listado de estimaciones </strong>
	</div>
	<table class="table_sample table_normal">
		<tbody>
			<tr>
				<th> No. </th>
				<th> Nombre </th>
				{% if almenos_coordinador %} <th> Monto </th>
				<th> F. de Pago </th>{% endif %}
				<th> Editar </th>
			</tr>
		{% for estimacion in contrato.get_estimaciones %}
			<tr>
				<td>{{ estimacion.consecutive }}</td>
				<td><a href="{% url 'proyectos:estimate_detail' estimacion.id %}">Estimación {{ estimacion.consecutive }}</a></td>
				{% if almenos_coordinador %}<td>{% language 'en' %}$ {{ estimacion.total_estimate.total|intcomma }}{% endlanguage %}</td>
				<td>{{ estimacion.payment_date|date:"d/F/Y" }}</td>{% endif %}
				<td>
					<a href="{% url 'proyectos:editar_estimacion' estimacion.pk %}">Editar</a>{% if almenos_coordinador %} /
					<a class="anchor_est_delete" data-model="Estimate" data-id="{{ estimacion.id }}" href="#">Eliminar</a>{% endif %}
				</td>
			</tr>
		{% endfor %}
			<tr>
				<td colspan="5">
					<a href="{% url 'proyectos:nueva_estimacion' contrato.id %}">Crear estimación</a>
				</td>
			</tr>
		</tbody>
	</table>
{% elif contrato.concept_set.exists %}
	<div class="cont_message text-center"> No existen estimaciones para este contrato aún. <a href="{% url 'proyectos:nueva_estimacion' contrato.id %}">Crea una aquí</a>.</div>
{% endif %}
<br>
<br>
{% if almenos_coordinador %}
	<div class="cont_listado">
		<strong> Listado de retenciones </strong>
		<div class="float-right"><span class="oi oi-plus" style="display:none" id="toggle-button-1"></span><span class="oi oi-minus" id="toggle-button-2"></span></div>
	</div>
	{% if contrato.retenciones_set.exists %}
		<table class="table_sample table_normal" id="toggle-hide">
			<tbody>
				<tr>
					<th> Nombre </th>
					<th> Valor </th>
				</tr>
			{% for retencion in contrato.retenciones_set.all %}
				<tr>
					<td>{{ retencion.nombre }}</td>
					<td>{% if retencion.tipo == 'AMOUNT' %}$ {% endif %}{% language 'en' %}{{ retencion.valor|intcomma }}{% endlanguage %}{% if retencion.tipo == 'PERCENTAGE' %}%{% endif %}</td>
				</tr>
			{% endfor %}
				<tr>
					<td colspan="2">
						<a href="{% url 'proyectos:catalogo_retenciones' contrato.id %}">Editar Retenciones</a>
					</td>
				</tr>
			</tbody>
		</table>
	{% else %}
		<div id="toggle-hide" class="cont_message text-center">¡No hay retenciones existentes, crear <a href="{% url 'proyectos:catalogo_retenciones' contrato.id %}">aquí</a>.</div>
	{% endif %}
{% endif %}
{% endlanguage %}
{% endblock %}
