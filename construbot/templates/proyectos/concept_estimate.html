{% load humanize %}
{% load i18n %}
{% load projecttags %}
{% if pdf %}
  {% load static i18n compress %}
  {% load bootstrap4 %}
  <!DOCTYPE html>
  <html lang="es">
    <head>
      <meta charset="utf-8">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      <title>{% block title %}Construbot{% endblock title %}</title>
      <meta name="description" content="{% block metadescription %}{% endblock metadescription %}">
      <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
      <meta name="author" content="{% block author %}{% endblock author %}">
      {# Bootstrap 4 #}
      {% bootstrap_css %}
      <!-- ICONOS Iconic para Bootstrap 4 -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css" integrity="sha256-BJ/G+e+y7bQdrYkS2RBTyNfBHpA9IuGaPmf9htub5MQ=" crossorigin="anonymous" />
      <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
      {% compress css %}
        <link href="{% static 'css/pdf.css' %}" rel="stylesheet">
        {% block css %}
        <style type="text/css">
          tr { page-break-inside: avoid !important; }
        </style>
        {% endblock css %}
      {% endcompress %}
    </head>
{% endif %}
<!--<span class="badge badge-pill badge-primary">¿Imprimir con anticipo?</span>
<span class="badge badge-pill badge-primary">¿Imprimir con retenciones?</span>
<br>
<br>-->
<table class="estimate">
  <thead>
      <tr>
        <th colspan="5" style="border-style:none;">
          <div class="cont_est_title">
            <h4> {{ estimate.project.cliente.cliente_name }}</h4>
            <p>{{ estimate.project.contrato_name }} </p>
            <p> Estimación de obra </p>
          </div>
        </th>
        <th colspan="7" style="border-style:none;">
          <table class="informacion">
            <tr>
              <th>Contratista:</th>
              <td class="bc subrayado"> {{ estimate.project.cliente.company.company_name }} </td>
            </tr>
            <tr>
              <th>Contrato:</th>
              <td class="bc subrayado"> {{ estimate.project.code }} </td>
            </tr>
            <tr>
              <th>Estimación N°:</th>
              <td class="bc subrayado"> {{ estimate.consecutive|stringformat:"02d" }} </td>
            </tr>
            <tr>
              <th>Fecha:</th>
              <td class="bc subrayado"> {{ estimate.auth_date|date:"d/F/Y" }} </td>
            </tr>
            <tr>
              <th>Período:</th>
              <td class="bc subrayado"> Del {{ estimate.start_date|date:"d/F/Y" }} al {{ estimate.finish_date|date:"d/F/Y" }} </td>
            </tr>
          </table>
        </th>
      </tr>   
      <tr class="center" style="background:#e4e4e4;">
        <th rowspan="2">N°</th>
        <th rowspan="2" style="width: 250px;" >CONCEPTOS DE OBRA</th>
        <th colspan="4">CONTRATADO</th>
        <th colspan="2">ESTIMADO ANTERIOR</th>
        <th colspan="2">ESTIMADO A LA FECHA</th>
        <th colspan="2">ESTA ESTIMACIÓN</th>
      </tr>
      <tr class="center" style="background:beige;">
        <th>UNIDAD</th>
        <th>CANTIDAD</th>
        <th>P.U.</th>
        <th>IMPORTE</th>
        <th>CANTIDAD</th>
        <th>IMPORTE</th>
        <th>CANTIDAD</th>
        <th>IMPORTE</th>
        <th>CANTIDAD</th>
        <th>IMPORTE</th>
      </tr>
    </thead>
    <tbody>
      {% language 'en' %}
      {% for concepto in conceptos %}
        <tr>
          <td> {{ concepto.code }} </td>
          <td style="width: fit-content;"> {{ concepto.concept_text }}</td>
          <td> {{ concepto.unit.unit }} </td>
          <td class="right"> {{ concepto.total_cuantity|floatformat:"2"|intcomma }} </td>
          <td class="right"> $ {{ concepto.unit_price|floatformat:"2"|intcomma }} </td>
          <td class="right"> $ {{ concepto.importe_contratado|floatformat:"2"|intcomma }}</td>
          {% if concepto.cantidad_estimado_anterior %}
            <td class="right"> {{ concepto.cantidad_estimado_anterior|floatformat:"2"|intcomma }} </td>
            <td class="right">$ {{ concepto.anterior|floatformat:"2"|intcomma }}</td>
          {% else %}
            <td style="text-align: center;"> - </td>
            <td style="text-align: center;"> - </td>
          {% endif %}
          <td class="right"> {{ concepto.cantidad_estimado_ala_fecha }} </td>
          <td class="right"> ${{ concepto.acumulado|floatformat:"2"|intcomma }} </td>
          <td class="right"> {{ concepto.cantidad_esta_estimacion }} </td>
          <td class="right"> ${{ concepto.estaestimacion|floatformat:"2"|intcomma }} </td>
        </tr>
      {% endfor %}
      <tr>
        <td class="right" colspan="2"><strong>Totales Estimación: </strong></td>
        <td class="right" colspan="4"> ${{ conceptos.importe_total_contratado.total|floatformat:"2"|intcomma }} </td>
        <td class="right" colspan="2"> ${{ conceptos.importe_total_anterior.total|floatformat:"2"|intcomma }} </td>
        <td class="right" colspan="2"> ${{ conceptos.importe_total_acumulado.total|floatformat:"2"|intcomma }} </td>
        <td class="right" colspan="2"> ${{ total_estimacion|floatformat:"2"|intcomma }} </td>
      </tr>
      <tr>
      </tr>
      {% if estimate.mostrar_anticipo %}
        <tr>
          <td colspan="6" class="border-w"></td>
          <td colspan="6" class="text-center" style="background:#e4e4e4;"><strong>Anticipos</strong></td>
        </tr>
        <tr>
          <td colspan="6" class="border-w"></td>
          <td colspan="4" class="text-right"><strong>Amortización de anticipo ({{ estimate.project.anticipo }}%)</strong></td>
          <td colspan="2" class="text-right"> ${% get_amortizacion_de_anticipo estimate.project.anticipo %} </td>
        </tr>
        <tr>
          <td colspan="6" class="border-w"></td>
          <td colspan="4" class="text-right"><strong>Subtotal de Estimación:</strong></td>
          <td colspan="2" class="text-right"> ${% get_subtotal estimate.project.anticipo total_estimacion %} </td>
        </tr>
      {% endif %}
      <tr>
      </tr>
      {% if estimate.mostrar_retenciones %}
        <tr>
          <td colspan="6" class="border-w"></td>
          <td colspan="6" class="text-center" style="background:#e4e4e4;"><strong>Retenciones</strong></td>
        </tr>
        {% for retencion in estimate.project.retenciones_set.all %}
          <tr>
            <td colspan="6" class="border-w"></td>
            <td colspan="4" class="text-right">{{ retencion.nombre }}</td>
            <td colspan="2" class="text-right"> {% if retencion.tipo == 'AMOUNT' %}$ {% endif %}{{ retencion.valor }}{% if retencion.tipo == 'PERCENTAGE' %}%{% endif %} </td>
          </tr>
        {% endfor %}
        <tr>
          <td colspan="6" class="border-w"></td>
          <td colspan="4" class="text-right"><strong>Total de Retenciones:</strong></td>
          <td colspan="2" class="text-right"> ${% get_total_retenciones estimate.project.retenciones_set.all estimate.project.anticipo total_estimacion %} </td>
        </tr>
      {% endif %}
      <tr>
        <td colspan="6" class="border-w-sp"></td>
        <td colspan="4" class="text-right"><strong>TOTAL FINAL:</strong></td>
        <td colspan="2" class="text-right"> ${% get_total_final estimate.project.retenciones_set.all estimate.project.anticipo total_estimacion %} </td>
      </tr>
      {% endlanguage %}
    </tbody>
    <tfoot>
      <tr>
        <td class="cont_firmas" colspan="12">
          <div class="cont_firma">
            <div class="bc subrayado_f"></div>
            <p> <strong>{{ estimate.supervised_by.first_name }} {{ estimate.supervised_by.last_name }}</strong> </p>
            <p> <strong>Supervisor de Obras </strong></p>
            <p> <strong>{{ request.user.currently_at.company_name }}</strong> </p>
          </div>
          {% for firma in estimate.auth_by.all %}
            <div class="cont_firma">
              <div class="bc subrayado_f"></div>
              <strong>{{ firma.destinatario_text }}</strong><br>
              {% if firma.puesto %}
                <strong>{{ firma.puesto }}</strong><br>
                <strong>{{ firma.cliente.cliente_name }}</strong>
              {% else %}
                <strong>{{ firma.cliente.cliente_name }}</strong><br>
                <p style="color:white">-</p>
              {% endif %}
            </div>
          {% endfor %}
        </td>
      </tr>
    </tfoot>
</table>
{% if pdf %}</html>{% endif %}