{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load bootstrap4 %}
{% load humanize %}
{% block css %}
    <link href="{% static 'autocomplete_light/select2.css' %}" type='text/css' media='all' rel='stylesheet'>
{% endblock css %}
{% block css_no_compress %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/css/tempusdominus-bootstrap-4.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
{% endblock css_no_compress %}
{% block javascript_no_compress %}
    <script src='https://cdn.jsdelivr.net/npm/moment@2.20.1/moment.min.js'></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/js/tempusdominus-bootstrap-4.min.js"></script>
{% endblock javascript_no_compress %}
{% block javascript %}
    <script type="text/javascript">
        var setPrefix = '{{ image_formset_prefix }}'.split(',').map(function(x){return x.replace(/&#39;|\[|\]|\s/g, '')});
    </script>
    <script src="{% static 'js/inlineform.js' %}"></script>
    <script src="{% static 'js/estimate_button.js' %}"></script>
    <script type="text/javascript">
        var fileSets = document.getElementsByClassName('dynamic-form');
        var formset = undefined;
        for(var i = 0; i<fileSets.length; i++){
            formset = new Formset();
            formset.setup({
                prefix: setPrefix[i],
                callbacks: callbacks,
                form_selector: '.set-' + i,
                nested: true
            });
        }
        function event_appear(){
            $(".del-msj").css("display", "block");
        }
        function event_move(){
            $(".del-msj")[0].style.top = event.clientY+'px';
            $(".del-msj")[0].style.left = event.clientX+10+'px';
        }
        function erase(){
            $(".del-msj").css("display", "none");
        }
    </script>
    <script type="text/javascript" src="{% static 'autocomplete_light/jquery.init.js' %}"></script>
    <script type="text/javascript" src="{% static 'autocomplete_light/autocomplete.init.js' %}"></script>
    <script type="text/javascript" src="{% static 'autocomplete_light/select2.js' %}"></script>
    <script type="text/javascript">
        $(document).ready(function(){
            var fecha = [$("#id_auth_date"), $("#id_start_date"), $("#id_finish_date"), $("#id_payment_date")];
            for(var i=0; i<fecha.length; i++){
                if(fecha[i].length>0){
                    var fecha_limpia = fecha[i][0].value.replace(/\[|\'|\]/g,'');
                    var padre = fecha[i].parent();
                    padre[0].style.position = 'relative';
                    fecha[i].datetimepicker({'format':"YYYY-MM-DD"});
                    if (fecha_limpia){
                        fecha[i][0].value = fecha_limpia;
                    }
                }
            }
        });
    </script>
{% endblock javascript %}
{% block content %}
{% language 'es' %}
    <div class="del-msj alert alert-danger"><p>Si le das click será eliminado cuando sea guardado el formulario.</p></div>
    <form role="form" method="post" class="form" enctype="multipart/form-data">
        {% csrf_token  %}
            <h3>Projecto: {{ project_instance.contrato_shortName }}</h3>
            <div class='fila_par'>
                <h4 style="margin: 0 0 10px 0;">Datos Generales de la Estimación.</h4>
                {% bootstrap_form form %}
            </div>
        {{ generator_inline_concept.management_form }}
        {% for frm, code in generator_zip %}
            <div class="{% cycle 'fila_impar' 'fila_par' %}">
                <div style="text-align: center;"><h4>Concepto: {{ code }}</h4></div>
                {{ frm.id }}
                {% bootstrap_field frm.concept %}
                {% bootstrap_field frm.observations %}
                <div class="row">
                    <div class="col-md-3">
                        {% bootstrap_field frm.largo %} 
                    </div>
                    <div class="col-md-3">
                        {% bootstrap_field frm.ancho %}
                    </div>
                    <div class="col-md-3">
                        {% bootstrap_field frm.alto %}
                    </div>
                    <div class="col-md-3 row">
                        <div class="col-xl-4">
                            <button style="margin-top:29px" class="calcular_cantidad btn btn-sm btn-primary">Calcular</button>
                        </div>
                        <div class="col-xl-8">
                            {% bootstrap_field frm.cuantity_estimated %}
                        </div>
                    </div>
                    <div class="col-12">
                        <i>Alto, Largo y Ancho son operandos para calcular la cantidad estimada. Si deseas puedes dejarlos en blanco y poner directamente la cantidad estimada en el campo.</i>
                    </div>
                </div>
                <br>
                {% if frm.nested %}
                    {{ frm.nested.management_form }}
                    <div class="dynamic-form">
                        {{ frm.nested.non_form_errors }}
                        {% for nested_form in frm.nested.forms %}
                            <div class="set-{{ forloop.parentloop.counter0 }}">
                                {% bootstrap_form nested_form %}
                            </div>
                        {% endfor %}
                        <button type="button" class="btn btn-dark add-form-row">Agregar más imagenes</button>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
        <div class="cont_buttons">
            <button class="btn"><a href="{% url 'proyectos:contrato_detail' pk=project_instance.pk %}" id="cancelar" data-dismiss="modal">Cancelar</a></button>
            <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
    </form>
{% endlanguage %}
{% endblock %}
