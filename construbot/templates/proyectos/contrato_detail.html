{% extends "base.html" %}
{% load humanize %}
{% block title %} Detalle de {{ contrato.contrato_shortName }} {% endblock %}
{% block javascript %}
    <script type="text/javascript">
    let url_for_list = '{% url "proyectos:proyect_dashboard" %}'
    $(document).ready(function(){
        let len = 0;
        if($(".icon_right").length){
            var intcomma = function(value) {
                // inspired by django.contrib.humanize.intcomma, thanks to @banterabilitybanterability
                var origValue = String(value);
                var newValue = origValue.replace(/^(-?\d+)(\d{3})/, '$1,$2');
                if (origValue == newValue){
                    return newValue;
                } else {
                    return intcomma(newValue);
                }
            };
            function lanzar_catalogo_conceptos(){
                var data_id = $("#dato")[0].getAttribute("data-id");
                $.ajax({
                    url: "{% url 'construbot.proyectos:catalogo_conceptos_listado' contrato.id %}",
                    success: function(result){
                        result = result.conceptos;
                        len = result.length;
                        if(len>0){
                            $(".table_results")[0].style.display = "inline-table";
                            for(i=1; i<=len; i++){
                                var row = $(".table_results")[0].insertRow(i);
                                var row_content = "<td>"+result[i-1]["code"]+"</td><td style='text-align:left;'>"+result[i-1]["concept_text"]+"</td><td>"+result[i-1]["unit"]+"</td><td>"+result[i-1]["cuantity"]+"</td><td>"+"$ "+intcomma(result[i-1]["unit_price"])+"</td>";
                                row.innerHTML = row_content;
                            }
                        }
                    }
                });
            }
            $(".icon_right").on("click", function(){
                lanzar_catalogo_conceptos();
            });
            $(".icon_right-up").on("click", function(){
                if(len>0){
                    for(i=0; i<len; i++){
                        $(".table_results")[0].deleteRow(1);
                    }
                }
            });
            let t1;
            $( ".toggle-button-2" ).click(function(evt) {
                $(evt.currentTarget.parentElement).find(".toggle-button-2").css("display", "none");
                $(evt.currentTarget.parentElement).find(".toggle-button-1").css("display", "block");
                $(evt.currentTarget.parentElement.parentElement.nextElementSibling).css("display", "none")
            });
            $( ".toggle-button-1" ).click(function(evt) {
                $(evt.currentTarget.parentElement).find(".toggle-button-2").css("display", "block");
                $(evt.currentTarget.parentElement).find(".toggle-button-1").css("display", "none");
                $(evt.currentTarget.parentElement.parentElement.nextElementSibling).css("display", "block")
            });
        }
        $(".lanzar-contrato").on("click", function(evt){
            let url = evt.currentTarget.dataset['url'];
            $(".contrato-widget").find("object").attr("data", url);
        });
    });
    </script>
{% endblock javascript %}
{% block content %}
<h2 class="title" > Reporte de {% if not contrato.is_root %}sub{% endif %}contrato </h2>
<div id="dato" data-id="{{ contrato.id }}"></div>
<div class="cont_table_sample">
    <table class="table_sample table_detalle">
        <tr>
            <th colspan="2">{{ contrato.folio }}. {{ contrato.contrato_shortName }}</th>
        </tr>
        <tr>
            <td>Código de contrato</td>
            <td>{{ contrato.code }}</td>
        </tr>
        <tr>
            <td>Nombre corto</td>
            <td>{{ contrato.contrato_shortName }}</td>
        </tr>
        <tr>
            <td>{{ contrato.contraparte.tipo_display }}</td>
            <td><a href="{% url 'construbot.proyectos:cliente_detail' contrato.contraparte.id %}">{{ contrato.contraparte.cliente_name }}</a></td>
        </tr>
        <tr>
            <td>Sitio</td>
            <td><a href="{% url 'construbot.proyectos:sitio_detail' contrato.sitio.id %}">{{ contrato.sitio.sitio_name }}</a></td>
        </tr>
        {% if almenos_coordinador %}
        <tr>
            <td>Monto sin IVA</td>
            <td>$ {{ contrato.monto|intcomma }}</td>
        </tr>
        {% endif %}
        <tr>
            <td>Fecha de Firma</td>
            <td>{{ contrato.fecha|date:"d/F/Y" }}</td>
        </tr>
        <tr>
            <td>¿Terminado?</td>
            <td><strong>{% if status %}Sí{% else %}No{% endif %}</strong></td>
        </tr>
        {% if not contrato.is_root %}
            <tr>
                <td>Contrato Padre</td>
                <td><a href="{% url 'proyectos:contrato_detail' contrato.get_parent.pk %}">{{ contrato.get_parent.contrato_shortName }}</a></td>
            </tr>
        {% endif %}
        {% if almenos_coordinador %}
        <tr>
            <td class="text-center" colspan="2"><a href="{% url 'proyectos:editar_contrato' contrato.pk %}">Editar Contrato</a></td>
        </tr>
        {% endif %}
    </table>
</div>
<br>
{% endblock %}
